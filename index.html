<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Debuugo å±‹å±‹ Web</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --board-width: 720px;
      --cell-size: 60px;
      --side-width: 340px;
    }
    body{font-family:Arial;margin:0;background:#f2f4f7;color:#222;}
    header{background:#2b3a67;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;}
    header h1{margin:0;font-size:18px;}
    header .meta{font-size:13px;opacity:0.9;}
    #wrap{
      display:flex;
      gap:12px;
      height:calc(100vh - 64px);
    }


    /* å·¦æ¬„ */
    #left{
      width:200px; /* å¯ä¾éœ€æ±‚èª¿æ•´ */
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:12px;
      background:#f9fafc;
      border-right:1px solid #e3e7ee;
    }

    /* ä¸­é–“ï¼šåœ°åœ– */
    #center{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:12px;
    }
    /* boardContainer ä¿ç•™åŸæ¨£ */
    #boardContainer{
      width:var(--board-width);
      height:var(--board-width);
      overflow:auto;
      border-radius:8px;
      background-color:#000;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      padding:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06);
    }
    /* åœ°åœ–æ ¼å­ */
    #board{display:grid;grid-template-columns:repeat(11,var(--cell-size));grid-auto-rows:var(--cell-size);gap:6px;justify-content:center;}
    .cell{border:1px solid rgba(255,255,255,0.3);border-radius:6px;background: rgba(255,255,255,0.75);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:4px;font-size:12px;text-align:center;box-sizing:border-box;}
    .cell.ground{background:#e6f7e9;}
    .cell.upper{background:#e8eefc;}
    .cell.basement{background:#fdecea;}
    .playerToken{background:#ffd54f;border-radius:50%;padding:6px 8px;font-size:11px;box-shadow:0 1px 2px rgba(0,0,0,0.1);}

    /* å³æ¬„ */
    #right{
      width:340px; 
      border-left:1px solid #e3e7ee;
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:#fff;
    }

    .panel{background:#fff;border-radius:6px;padding:10px;border:1px solid #eee;box-shadow:0 1px 2px rgba(0,0,0,0.02);}
    
    #chatBox{height:360px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:6px;}
    .chatMsg{padding:6px 8px;border-radius:6px;max-width:100%;word-break:break-word;}
    .chatMsg.me{background:#e6fff1;align-self:flex-end;}
    .chatMsg.system{background:#fff4e6;color:#a65e00;border:1px dashed #f0c080;align-self:center;}
    .chatMsg.other{background:#f6f7fb;align-self:flex-start;}
    
    #cardsBox{height:140px;overflow:auto;display:flex;flex-direction:column;gap:6px;}
    .card{border:1px solid #e6e9ef;padding:6px;border-radius:6px;background:#fff;}
    
    /* controls bottom */
    #controls{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e6e9ef;padding:10px;display:flex;justify-content:center;gap:10px;align-items:center;}
    .btn{padding:8px 12px;border-radius:6px;border:1px solid #c9d2e6;background:#f5f8ff;cursor:pointer;}
    .btn.primary{background:#2b6df6;color:#fff;border-color:#2356d1;}
    
    /* inputs */
    input, select, button{font-size:14px;}
    
    /* responsive */
    @media(max-width:1100px){
      #wrap{flex-direction:column;}
      #left,#center,#right{width:100%;}
      #boardContainer{width:100%;height:60vh;}
    }

    @media(max-width:900px){
      #wrap{flex-direction:column;}
      #left{order:1}
      #right{order:2;width:100%}
      #boardContainer{width:100%;height:60vh;}
    }

    /* è¦å‰‡è¦–çª—å°ˆç”¨ CSS */
    .rule-content { display: none; }
    #tab1 { display: block; } /* é è¨­é¡¯ç¤ºç¬¬ä¸€å€‹åˆ†é  */
  </style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center;">
    <h1>Debuugo å±‹å±‹</h1>
    <button class="btn" onclick="document.getElementById('rules-modal').style.display='block'" style="margin-left:15px; background:#444; color:#fff; border:1px solid #666;">
      ğŸ“– é–±è®€ç”Ÿå­˜æ‰‹å†Š
    <button class="btn" onclick="document.getElementById('k02').style.display='block'" style="margin-left:15px; background:#444; color:#fff; border:1px solid #666;">
      ğŸ“– é–±è®€ç”Ÿå­˜æ‰‹å†Š
    </button>
  </div>

  <div class="meta">
    Room: <span id="roomLabel">â€”</span> &nbsp;|&nbsp;
    Player: <span id="playerLabel">â€”</span>
  </div>
</header>

<div id="wrap">
  <!-- å·¦æ¬„ï¼šç©å®¶æ“ä½œ / ç©å®¶åˆ—è¡¨ -->
  <div id="left">
    <div style="display:flex;gap:8px;flex-wrap:wrap; align-items:center;">
      <input id="pname" placeholder="ä½ çš„åå­—" />
      <button class="btn" onclick="login()">ç™»å…¥</button>
      <input id="joinRoomId" placeholder="æˆ¿é–“ID">
      <button class="btn" onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
      <input id="roomName" placeholder="æ–°æˆ¿é–“åç¨±">
      <button class="btn primary" onclick="createRoom()">å‰µå»ºæˆ¿é–“</button>
    </div>

    <div class="panel" style="width:220px; margin-top:12px;">
      <h3>æˆ¿é–“ç©å®¶</h3>
      <ul id="playerList" style="list-style:none; padding-left:0; margin:0;"></ul>
    </div>
  </div>

  <!-- ä¸­é–“æ¬„ï¼šåœ°åœ– + æ¨“å±¤æ§åˆ¶ + èº«åˆ†/Haunt -->
  <div id="center">
    <div id="boardContainer" class="panel">
      <div id="board"></div>
    </div>

    <div id="floor-controls" style="margin-top:12px; display:flex; gap:6px; justify-content:center;">
      <button onclick="setFloor('Basement')">B1</button>
      <button onclick="setFloor('Ground')">1F</button>
      <button onclick="setFloor('Upper')">2F</button>
    </div>

    <div style="display:flex;gap:8px; margin-top:12px;">
      <div class="panel" style="flex:1">
        <div><strong>æˆ‘çš„èº«åˆ†</strong></div>
        <div id="myRole">â€”</div>
      </div>
      <div class="panel" style="width:220px">
        <div><strong>Haunt ç‹€æ…‹</strong></div>
        <div id="hauntStatus">â€”</div>
      </div>
    </div>
  </div>

  <!-- å³æ¬„ï¼šèŠå¤© + æ‰‹ç‰Œ + æˆ¿ä¸»æ“ä½œ -->
  <div id="right">
    <div class="panel">
      <h3>èŠå¤©</h3>
      <div id="chatBox" style="height:360px; overflow:auto;"></div>
      <div style="display:flex; gap:6px; margin-top:8px;">
        <input id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯" style="flex:1" />
        <select id="chatType">
          <option value="player">ä¸€èˆ¬</option>
          <option value="system">ç³»çµ±</option>
          <option value="private">ç§èŠ</option>
        </select>
      </div>
      <div style="display:flex; gap:6px; margin-top:6px;">
        <select id="chatReceiver" style="flex:1"></select>
        <button onclick="sendChat()">é€å‡º</button>
      </div>
    </div>

    <div class="panel" style="margin-top:12px;">
      <h3>æ‰‹ç‰Œ / é“å…·</h3>
      <div id="cardsBox"></div>
    </div>

    <div class="panel" style="margin-top:12px;">
      <h3>æˆ¿ä¸»æ“ä½œ</h3>
      <button class="btn" onclick="assignRolesPrompt()">åˆ†ç™¼è§’è‰²ï¼ˆéš¨æ©Ÿï¼‰</button>
      <button class="btn" onclick="resetRoom()">é‡ç½®æˆ¿é–“ï¼ˆæ¸…ç©º Tiles/Players/GSï¼‰</button>
    </div>
  </div>
</div>


<div id="controls">
  <button class="btn" onclick="move('left')">â†</button>
  <button class="btn" onclick="move('up')">â†‘</button>
  <button class="btn" onclick="move('down')">â†“</button>
  <button class="btn" onclick="move('right')">â†’</button>
  <button class="btn" onclick="draw('event')">æŠ½äº‹ä»¶</button>
  <button class="btn" onclick="draw('item')">æŠ½ç‰©å“</button>
  <button class="btn" onclick="draw('omen')">æŠ½é å…†</button>
</div>

<div id="rules-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; color:#fff; backdrop-filter: blur(5px);">
  <div style="max-width:600px; margin:5vh auto; background:#222; border:2px solid #0f0; padding:20px; border-radius:10px; height: 80vh; display:flex; flex-direction:column; box-shadow: 0 0 20px rgba(0,255,0,0.2);">
    
    <div style="flex-shrink:0;">
      <h2 style="color:#0f0; text-align:center; margin-top:0; border-bottom:1px dashed #0f0; padding-bottom:10px; font-family: monospace;">
        ğŸ“– Debuugo å¯¦é©—å®¤å®ˆå‰‡
      </h2>

      <div style="display:flex; gap:5px; margin-bottom:15px;">
        <button onclick="showTab('tab1')" style="flex:1; padding:10px; background:#333; color:#fff; border:1px solid #555; cursor:pointer;">ğŸ¯ ç›®æ¨™</button>
        <button onclick="showTab('tab2')" style="flex:1; padding:10px; background:#333; color:#fff; border:1px solid #555; cursor:pointer;">ğŸ”„ æµç¨‹</button>
        <button onclick="showTab('tab3')" style="flex:1; padding:10px; background:#333; color:#fff; border:1px solid #555; cursor:pointer;">ğŸ² æ•¸å€¼</button>
        <button onclick="showTab('tab4')" style="flex:1; padding:10px; background:#333; color:#fff; border:1px solid #555; cursor:pointer;">ğŸ’€ ä½œç¥Ÿ</button>
      </div>
    </div>

    <div style="flex:1; overflow-y:auto; padding-right:10px; line-height:1.6; font-size:15px;">
      
      <div id="tab1" class="rule-content">
        <h3 style="color:#81c784;">ğŸ® éŠæˆ²ç›®æ¨™</h3>
        <p>æ­¡è¿ä¾†åˆ° Debuugo å±‹å±‹ï¼é€™è£¡å……æ»¿äº† Bug èˆ‡æ ¡åœ’å‚³èªªã€‚</p>
        <div style="background:#333; padding:10px; border-radius:5px; margin-bottom:10px;">
          <strong>éšæ®µä¸€ï¼šæ¢ç´¢ (Debug Phase)</strong>
          <ul style="margin:5px 0 0 20px;">
            <li>æ­¤æ™‚å¤§å®¶æ˜¯éšŠå‹ã€‚</li>
            <li>ç›®æ¨™ï¼šé–‹å•Ÿæ–°æˆ¿é–“ï¼Œè’é›†ç‰©å“ï¼Œå¼·åŒ–æ•¸å€¼ã€‚</li>
            <li>å°å¿ƒï¼é å…†å¡æŠ½è¶Šå¤šï¼Œç³»çµ±è¶Šå®¹æ˜“å´©æ½°ã€‚</li>
          </ul>
        </div>
        <div style="background:#333; padding:10px; border-radius:5px;">
          <strong>éšæ®µäºŒï¼šä½œç¥Ÿ (System Crash)</strong>
          <ul style="margin:5px 0 0 20px;">
            <li>æŸäººæœƒæˆç‚º<span style="color:#ff5252">å›å¾’</span>ï¼</li>
            <li>å€–å­˜è€…å¿…é ˆå®ŒæˆåŠ‡æœ¬ä»»å‹™ï¼ˆå¦‚é‡å¯«æ ¸å¿ƒä»£ç¢¼ï¼‰æ‰èƒ½ç²å‹ã€‚</li>
          </ul>
        </div>
      </div>

      <div id="tab2" class="rule-content" style="display:none;">
        <h3 style="color:#64b5f6;">ğŸ”„ å›åˆæµç¨‹</h3>
        <ol>
          <li><strong>ç§»å‹•ï¼š</strong> é€Ÿåº¦å€¼ = å¯èµ°æ­¥æ•¸ã€‚</li>
          <li><strong>æ¢ç´¢ï¼š</strong> èµ°åˆ°åœ°åœ–é‚Šç·£çš„é–€ï¼Œæœƒè‡ªå‹•é–‹å•Ÿæ–°æˆ¿é–“ã€‚</li>
          <li><strong>å¼·åˆ¶åœæ­¢ï¼š</strong> è‹¥æ–°æˆ¿é–“æœ‰åœ–ç¤ºï¼ˆäº‹ä»¶/ç‰©å“/é å…†ï¼‰ï¼Œå¿…é ˆåœä¸‹ä¸¦æŠ½å¡ã€‚</li>
          <li><strong>è¡Œå‹•ï¼š</strong> ä½¿ç”¨ç‰©å“ã€æ”»æ“Šï¼ˆä½œç¥Ÿå¾Œï¼‰ã€ç‰¹æ®Šèƒ½åŠ›ã€‚</li>
        </ol>
      </div>
      
      <div id="tab3" class="rule-content" style="display:none;">
        <h3 style="color:#ffd54f;">ğŸ“Š å±¬æ€§èˆ‡æª¢å®š</h3>
        <p><strong>ğŸ’ªåŠ›é‡ / âš¡é€Ÿåº¦ / ğŸ§ ç¥æ™º / ğŸ“šçŸ¥è­˜</strong></p>
        <p style="color:#ff5252;">âš ï¸ ç•¶ä»»ä¸€æ•¸å€¼æ­¸é›¶æ™‚ï¼Œè§’è‰²æ­»äº¡ã€‚</p>
        <hr style="border-color:#555;">
        <p><strong>ğŸ² ä»€éº¼æ˜¯ã€Œæª¢å®šã€ï¼Ÿ</strong></p>
        <p>ç•¶éŠæˆ²è¦æ±‚ã€ŒçŸ¥è­˜æª¢å®š 4+ã€æ™‚ï¼š</p>
        <ol>
          <li>æŸ¥çœ‹ä½ çš„çŸ¥è­˜æ•¸å€¼ï¼ˆä¾‹å¦‚ 3ï¼‰ã€‚</li>
          <li>ç³»çµ±æœƒå¹«ä½ æ“² 3 é¡†éª°å­ã€‚</li>
          <li>éª°å­ç¸½å’Œ â‰¥ 4 å³ç‚º<span style="color:#81c784">æˆåŠŸ</span>ï¼Œå¦å‰‡å¤±æ•—ã€‚</li>
        </ol>
      </div>

      <div id="tab4" class="rule-content" style="display:none;">
        <h3 style="color:#ff5252;">ğŸ’€ é å…†èˆ‡ä½œç¥Ÿ</h3>
        <p>ç•¶ä½ æŠ½åˆ° <span style="color:#ff5252; font-weight:bold;">é å…†å¡ (Omen)</span> æ™‚...</p>
        <p>å¿…é ˆé€²è¡Œä½œç¥Ÿåˆ¤å®šï¼</p>
        <div style="border: 2px solid #ff5252; padding:15px; text-align:center; background:#300; border-radius:8px;">
          <p style="margin:0;"><strong>ä½œç¥Ÿå…¬å¼ï¼š</strong></p>
          <p style="font-size:1.2em; font-weight:bold; margin:10px 0;">æ“² 6 é¡†éª°å­</p>
          <p style="margin:0;">è‹¥ <strong>é»æ•¸ç¸½å’Œ < ç›®å‰é å…†å¡ç¸½æ•¸</strong></p>
          <p style="font-size:1.5em; margin:10px 0;">ğŸ˜± ç³»çµ±å´©æ½° (ä½œç¥Ÿé–‹å§‹)</p>
        </div>
      </div>

    </div>

    <button onclick="document.getElementById('rules-modal').style.display='none'" style="flex-shrink:0; margin-top:20px; padding:15px; background:#0f0; color:#000; font-weight:bold; border:none; border-radius:5px; cursor:pointer;">
      æˆ‘å·²é–±è®€ä¸¦åŒæ„ä»¥ä¸Šæ¢æ¬¾ (é—œé–‰)
    </button>
  </div>
</div>
 
<div id="k01" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%);
    background:#222; color:#fff; border:2px solid #0f0; padding:20px; border-radius:10px; z-index:1000; cursor: move;
    min-width:250px; min-height:120px; box-shadow: 0 0 20px rgba(0,255,0,0.3);">
  <h3 id="k01-title" style="margin:0; cursor:inherit;"></h3>
  <p><strong>åŠŸèƒ½èªªæ˜ï¼š</strong> <span id="k01-effect"></span></p>
  <p><strong>èƒŒæ™¯ä»‹ç´¹ï¼š</strong> <span id="k01-lore"></span></p>
  <button onclick="closeRoomModal()">é—œé–‰</button>

  <!-- ä¼¸ç¸®æŠ“æ‰‹ -->
  <div id="k01-resize" style="position:absolute; width:15px; height:15px; bottom:5px; right:5px; cursor:se-resize;
       background:rgba(0,255,0,0.5); border-radius:3px;"></div>
</div>


<script>
/* --- client-side logic --- */
let myPlayerId = localStorage.getItem("myPlayerId") || null;
let myName = localStorage.getItem("myName") || "";
let currentRoomId = localStorage.getItem("currentRoomId") || null;
let syncTimer = null;
let currentFloor = "Ground"; // é è¨­ 1F
let tilesCache = [];
let playersCache = [];


// utility: handle call failures
const GAS_URL = "https://script.google.com/macros/s/AKfycbybSxgUC0p26Ps858A0Ii4U5hrUx1sjYcS2MBXtqxOnjS7S7Y3GB32k1Ls-1y4McPk14Q/exec";

function gsRun(fn, args = [], cb){
  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ fn, args })
  })
  .then(res => res.json())
  .then(data => {
    if(data?.error){
      alert("ä¼ºæœå™¨éŒ¯èª¤: " + data.error);
      console.error(data.error);
      return;
    }
    cb && cb(data);
  })
  .catch(err => {
    console.error("Fetch error", err);
    alert("ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨");
  });
}

// login
function login(){
  const name = document.getElementById("pname").value.trim();
  if(!name) return alert("è«‹è¼¸å…¥åå­—");
  myName = name;
  localStorage.setItem("myName", myName);
  gsRun("addPlayer", [name], (resp)=>{
    myPlayerId = resp.playerId; localStorage.setItem("myPlayerId", myPlayerId);
    document.getElementById("playerLabel").textContent = name + " ("+myPlayerId+")";
    alert("ç™»å…¥æˆåŠŸ: " + name);
  });
}

// create room
function createRoom(){
  const rn = document.getElementById("roomName").value || "Room";
  gsRun("createRoom", [rn], (roomId)=>{
    currentRoomId = roomId; localStorage.setItem("currentRoomId", roomId);
    document.getElementById("roomLabel").textContent = roomId;
    // auto add self
    if(!myPlayerId) login(); // ensure player exists
    setTimeout(()=>{ joinRoom(); }, 500);
    startSync();
  });
}

let TILE_POOL = [];

function loadTilePool(callback){
  gsRun("getTilePool", [], pool => {
    TILE_POOL = pool;
    console.log("Tile pool loaded:", TILE_POOL);
    if(callback) callback();
  });
}


// join room (adds player to room)
function joinRoom(){
  const rid = currentRoomId || document.getElementById("joinRoomId").value;
  if(!rid) return alert("è«‹è¼¸å…¥æˆ–å»ºç«‹æˆ¿é–“");
  if(!myPlayerId) return alert("è«‹å…ˆç™»å…¥");

  gsRun("addPlayerToRoom", [myName, rid], (player)=>{
    myPlayerId = player.playerId;
    localStorage.setItem("myPlayerId", myPlayerId);

    currentRoomId = rid;
    localStorage.setItem("currentRoomId", currentRoomId);

    document.getElementById("roomLabel").textContent = currentRoomId;
    document.getElementById("playerLabel").textContent =
      myName + " (" + myPlayerId + ")";

    startSync();
  });
}


// sync loop
function startSync(){
  if(syncTimer) clearInterval(syncTimer);
  loadAll();
  syncTimer = setInterval(loadAll, 1500);
}
function stopSync(){ if(syncTimer) clearInterval(syncTimer); syncTimer = null; }

// load everything
function loadAll(){
  if(!currentRoomId || !myPlayerId) return;
  gsRun("getRoomData",[currentRoomId], data=>{
    tilesCache = data.tiles || [];
    playersCache = data.players || [];

    renderBoard(tilesCache, playersCache);
    renderHaunt(data.haunt);
    renderMyRole(playersCache);
    loadChat();
    loadPlayersListForChat();
    renderPlayerList();
    loadCards();
  });
}




// render board
function renderBoard(tiles, players){
  const board = document.getElementById("board");
  board.innerHTML = "";

  const floorTiles = tiles.filter(t => t.floor === currentFloor);

  for(let y=0;y<11;y++){
    for(let x=0;x<11;x++){
      const gx = x - 5, gy = y - 5;
      const cell = document.createElement("div");
      cell.className = "cell";

      const tile = floorTiles.find(t => Number(t.x)===gx && Number(t.y)===gy);
      if(tile){
        cell.classList.add(
          tile.floor==="Ground" ? "ground" :
          tile.floor==="Upper" ? "upper" : "basement"
        );

        const title = document.createElement("div");
        title.textContent = tile.tileName;
        title.style.fontSize="12px";
        title.style.cursor="pointer";

        title.onclick = ()=>{
          showRoomModal(tile);
        };

        cell.appendChild(title);

        if(tile.tileName==="ç³»é¤¨å¤§å»³" && tile.floor==="Ground" && gx===0 && gy===0){
          cell.style.border="2px solid #0f0";
        }
      }

      const p = players.find(pl =>
        Number(pl.x)===gx &&
        Number(pl.y)===gy &&
        pl.floor===currentFloor
      );
      if(p){
        const token=document.createElement("div");
        token.className="playerToken";
        token.textContent=p.name;
        cell.appendChild(token);
      }

      board.appendChild(cell);
    }
  }
}


function renderPlayerList(){
  if(!currentRoomId) return;
  gsRun("getRoomPlayers",[currentRoomId], players=>{
    const container = document.getElementById("playerList");
    container.innerHTML = "";
    players.forEach(p=>{
      const div = document.createElement("div");
      div.textContent = p.name + (p.playerId===myPlayerId ? " (ä½ )" : "");
      div.style.padding = "6px 12px";
      div.style.border = "1px solid #ddd";
      div.style.borderRadius = "6px";
      div.style.background = "#f6f7fb";
      div.style.fontSize = "13px";
      div.style.cursor = "pointer";
      container.appendChild(div);
    });
  });
}

// render haunt
function renderHaunt(gs){
  const el = document.getElementById("hauntStatus");
  if(!gs) { el.textContent = "â€”"; return; }
  if(gs.hauntTriggered==="true") el.textContent = "Haunt! å›å¾’:"+ (gs.traitor||"unknown") + " åŠ‡æœ¬:"+ (gs.hauntScenario||"-");
  else el.textContent = "å°šæœªè§¸ç™¼ï¼ˆOmen "+(gs.omenCount||0)+")";
}

// render my role
function renderMyRole(players){
  const me = players.find(p=>p.playerId===myPlayerId);
  document.getElementById("myRole").textContent = me ? (me.role || "å°šæœªåˆ†é…") : "not in room";
}

// movement
function move(dir){
  if(!currentRoomId || !myPlayerId) return alert("å…ˆç™»å…¥ä¸¦åŠ å…¥æˆ¿é–“");
  const dx = dir==="left" ? -1 : dir==="right" ? 1 : 0;
  const dy = dir==="up" ? -1 : dir==="down" ? 1 : 0;
  gsRun("movePlayer",[myPlayerId, dx, dy, currentRoomId], res=>{
    if(res && res.error) alert(res.error);
    else loadAll();
  });
}

// draw card
function draw(type){
  if(!currentRoomId) return;
  gsRun("drawCard",[type, currentRoomId], res=>{
    if(res && res.error) alert(res.error);
    else alert("æŠ½åˆ°: " + (res.card ? res.card.name : JSON.stringify(res)));
    loadAll();
  });
}

// assign roles prompt
function assignRolesPrompt(){
  if(!currentRoomId) return alert("è«‹å…ˆåœ¨æˆ¿é–“è£¡");
  // fetch players and auto assign random 1 traitor rest heroes
  gsRun("getRoomPlayers",[currentRoomId], players=>{
    if(!players || players.length===0) return alert("æˆ¿å…§ç„¡ç©å®¶");
    const roles = [];
    const traitorIndex = Math.floor(Math.random()*players.length);
    for(let i=0;i<players.length;i++) roles.push(i===traitorIndex ? "Traitor" : "Hero");
    gsRun("assignRoles",[roles, currentRoomId], ret=>{ alert("å·²åˆ†ç™¼èº«åˆ†"); loadAll(); });
  });
}

// reset room (utility)
function resetRoom(){
  if(!currentRoomId) return;
  if(!confirm("é‡ç½®æˆ¿é–“æœƒæ¸…ç©º Tiles, Players, PlayerCards, Chat, GameState (é‡æ–°åˆå§‹åŒ–)ã€‚ç¢ºå®šï¼Ÿ")) return;
  // clear rows by rewriting headers only (quick approach)
  google.script.run.withSuccessHandler(()=>{
    alert("è«‹æ‰‹å‹•åœ¨è©¦ç®—è¡¨é‡æ–°å»ºç«‹æˆ–ç”¨ createInitialSheets åˆå§‹åŒ–ã€‚");
  }).createInitialSheets();
}

// ---------------- chat ----------------
function loadPlayersListForChat(){
  if(!currentRoomId) return;

  gsRun("getRoomPlayers",[currentRoomId], players=>{
    const sel = document.getElementById("chatReceiver");
    sel.innerHTML = "";

    players.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.playerId;
      opt.textContent = `${p.name} (${p.playerId})`;
      sel.appendChild(opt);
    });
  });
}

function loadChat(){
  if(!currentRoomId || !myPlayerId) return;

  gsRun("getMessagesForRoom",[myPlayerId, currentRoomId], msgs=>{
    const box = document.getElementById("chatBox");
    box.innerHTML = "";

    msgs.forEach(m=>{
      const div = document.createElement("div");

      div.className =
        "chatMsg " +
        (m.type==="system" ? "system" :
         m.playerId===myPlayerId ? "me" : "other");

      const t = new Date(m.timestamp);
      const time =
        ("0"+t.getHours()).slice(-2)+":"+
        ("0"+t.getMinutes()).slice(-2);

      div.innerHTML =
        `[${time}] <strong>${m.name}</strong>: ${m.message}`;

      box.appendChild(div);
    });

    box.scrollTop = box.scrollHeight;
  });
}


function sendChat(){
  const msg = document.getElementById("chatInput").value.trim();
  if(!msg) return;

  const type = document.getElementById("chatType").value;
  const recv =
    type==="private"
      ? document.getElementById("chatReceiver").value
      : "";

  gsRun(
    "sendMessageToRoom",
    [myPlayerId, myName, msg, currentRoomId, type, recv],
    ()=>{
      document.getElementById("chatInput").value = "";
      loadChat();
    }
  );
}


// load cards
function loadCards(){
  if(!currentRoomId) return;
  gsRun("getMyCards",[myPlayerId, currentRoomId], cards=>{
    const box = document.getElementById("cardsBox");
    box.innerHTML = "";
    cards.forEach(c=>{
      const div = document.createElement("div"); div.className="card";
      div.innerHTML = "<div><strong>"+c.cardName+"</strong> ("+c.type+")</div><div style='margin-top:6px'><button class='btn' onclick='useCard(\""+c.cardName+"\")'>ä½¿ç”¨</button></div>";
      box.appendChild(div);
    });
  });
}
function useCard(cardName){
  gsRun("useCard",[myPlayerId, cardName, currentRoomId], res=>{
    if(res && res.error) alert(res.error);
    else { alert("ä½¿ç”¨æˆåŠŸ: " + cardName); loadCards(); }
  });
}

// boot: if stored data exists, resume sync
if(localStorage.getItem("currentRoomId")) {
  currentRoomId = localStorage.getItem("currentRoomId");
  document.getElementById("roomLabel").textContent = currentRoomId;
}
if(localStorage.getItem("myName")){
  myName = localStorage.getItem("myName");
  document.getElementById("pname").value = myName;
}
if(localStorage.getItem("myPlayerId")) {
  myPlayerId = localStorage.getItem("myPlayerId");
  document.getElementById("playerLabel").textContent = (myName||"") + " (" + myPlayerId + ")";
}
if(currentRoomId && myPlayerId) startSync();

// 3. è¦å‰‡åˆ†é é‚è¼¯ (æ–°å¢åœ¨é€™è£¡)
function showTab(tabId) {
  var tabs = document.querySelectorAll('.rule-content');
  for (var i = 0; i < tabs.length; i++) {
    tabs[i].style.display = 'none';
  }
  document.getElementById(tabId).style.display = 'block';
}

// å‡è¨­ä½ å·²ç¶“æœ‰æˆ¿é–“è³‡æ–™é™£åˆ— roomData.tiles
// æ¯å€‹ tile ç‰©ä»¶æœ‰ name, effect, lore, x, y, floor

function showRoomModal(tile){
  document.getElementById("k01-title").innerText = tile.tileName;
  document.getElementById("k01-effect").innerText = tile.effect || "ç„¡åŠŸèƒ½èªªæ˜";
  document.getElementById("k01-lore").innerText = tile.lore || "ç„¡èƒŒæ™¯ä»‹ç´¹";
  document.getElementById("k01").style.display="block";
}

function closeRoomModal(){
  document.getElementById("k01").style.display="none";
}
const modal = document.getElementById("k01");
const resizeHandle = document.getElementById("k01-resize");


// æ‹–ç§»
function makeDraggable(el) {
  let isMouseDown = false;
  let offsetX, offsetY;

  el.addEventListener('mousedown', function(e) {
    if(e.target === resizeHandle) return; // é»æ“ŠæŠ“æ‰‹ä¸æ‹–å‹•
    isMouseDown = true;
    offsetX = e.clientX - el.getBoundingClientRect().left;
    offsetY = e.clientY - el.getBoundingClientRect().top;
    el.style.cursor = "grabbing";
  });

  document.addEventListener('mousemove', function(e) {
    if (!isMouseDown) return;
    el.style.left = (e.clientX - offsetX) + "px";
    el.style.top = (e.clientY - offsetY) + "px";
    el.style.transform = ""; // ç§»å‹•æ™‚æ¸…é™¤ translateX
  });

  document.addEventListener('mouseup', function() {
    isMouseDown = false;
    el.style.cursor = "move";
  });
}
makeDraggable(modal);

// ä¼¸ç¸®
let isResizing = false;
resizeHandle.addEventListener('mousedown', function(e){
  isResizing = true;
  e.stopPropagation(); // é˜²æ­¢æ‹–ç§»åŒæ™‚è§¸ç™¼
});

document.addEventListener('mousemove', function(e){
  if(!isResizing) return;
  const rect = modal.getBoundingClientRect();
  modal.style.width = Math.max(200, e.clientX - rect.left) + "px";
  modal.style.height = Math.max(100, e.clientY - rect.top) + "px";
});

document.addEventListener('mouseup', function(){
  isResizing = false;
});

// é—œé–‰ modal
function closeRoomModal(){
  modal.style.display = "none";
}

function setFloor(floor){
  currentFloor = floor;
  renderBoard(tilesCache, playersCache);
}

// éæ¿¾å‡ºç•¶å‰æ¨“å±¤çš„æˆ¿é–“
function filteredTilesForFloor(allTiles){
  return allTiles.filter(t => t.floor === currentFloor);
}

</script>
</body>
</html>
